
streams:
  - name: cccc-test
    documents:
          - s3://ai2-llm/pretraining-data/sources/cccc/v0/documents/CC-MAIN-2016-22/023ea1f78ccf5a1ea55ebd2a50a3aea042770ed3.jsonl.zst
    attributes:
      - c4_v2
      - dedupe_url
      - ft_lang_id_1e2
      - gopher_v2
      - tokenizer_repetitions_v2r2
      - whitespace_tokenizer_v1
    output:
      max_size_in_bytes: 2_000_000_000
      path: ${oc.env:HOME}/ai2-llm/pretraining-data/sources/cccc/v1/documents/test
      min_text_length: 25   # matches wikipedia
    filter:
      syntax: jq
      include:
        # Only English
        - >-
          (.attributes.ft_lang_id_1e2__ft_lang_id_1e2__en != null) and
          (.attributes.ft_lang_id_1e2__ft_lang_id_1e2__en[0][2] > 0.5)
      exclude:
        # Duplicated URLs
        - (.attributes.dedupe_url | length > 1)

        # C4 Rules
        - >-
          (.attributes.c4_v2__c4_v2__has_curly_brace != null) and
          (.attributes.c4_v2__c4_v2__has_curly_brace[0][2] > 0.5)
        - >-
          (.attributes.c4_v2__c4_v2__has_lorem_ipsum != null) and
          (.attributes.c4_v2__c4_v2__has_lorem_ipsum[0][2] > 0.5)
        - >-
          (.attributes.c4_v2__c4_v2__has_javascript != null) and
          (.attributes.c4_v2__c4_v2__has_javascript[0][2] > 0.5)

        # Gopher Rules
        - >-
          (.attributes.gopher_v2__gopher_v2__word_count != null) and
          (.attributes.gopher_v2__gopher_v2__word_count[0][2] < 50)
        - >-
          (.attributes.gopher_v2__gopher_v2__word_count != null) and
          (.attributes.gopher_v2__gopher_v2__word_count[0][2] > 100000)
        - >-
          (.attributes.gopher_v2__gopher_v2__median_word_length != null) and
          (.attributes.gopher_v2__gopher_v2__median_word_length[0][2] < 3)
        - >-
          (.attributes.gopher_v2__gopher_v2__median_word_length != null) and
          (.attributes.gopher_v2__gopher_v2__median_word_length[0][2] > 10)
        - >-
          (.attributes.gopher_v2__gopher_v2__symbol_to_word_ratio != null) and
          (.attributes.gopher_v2__gopher_v2__symbol_to_word_ratio[0][2] > 0.1)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_words_with_alpha_character != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_words_with_alpha_character[0][2] < 0.8)
        - >-
          (.attributes.gopher_v2__gopher_v2__required_word_count != null) and
          (.attributes.gopher_v2__gopher_v2__required_word_count[0][2] < 2)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_lines_starting_with_bullet_point != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_lines_starting_with_bullet_point[0][2] > 0.9)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_lines_ending_with_ellipsis != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_lines_ending_with_ellipsis[0][2] > 0.3)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_duplicate_lines != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_duplicate_lines[0][2] > 0.3)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_lines != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_lines[0][2] > 0.3)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_most_common_2gram != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_most_common_2gram[0][2] > 0.2)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_most_common_3gram != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_most_common_3gram[0][2] > 0.18)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_most_common_4gram != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_most_common_4gram[0][2] > 0.16)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_5grams != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_5grams[0][2] > 0.15)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_6grams != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_6grams[0][2] > 0.14)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_7grams != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_7grams[0][2] > 0.13)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_8grams != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_8grams[0][2] > 0.12)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_9grams != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_9grams[0][2] > 0.11)
        - >-
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_10grams != null) and
          (.attributes.gopher_v2__gopher_v2__fraction_of_characters_in_duplicate_10grams[0][2] > 0.10)

        # Remove repetitions
        - >-
          (.attributes.tokenizer_repetitions_v2r2__tokenizer_repetitions_v2r2__doc_max_score_repetition != null) and
          (.attributes.tokenizer_repetitions_v2r2__tokenizer_repetitions_v2r2__doc_max_score_repetition > 10)

work_dir:
  input: "/tmp/cccc-test/mix/input"
  output: "/tmp/cccc-test/mix/output"

processes: 100
