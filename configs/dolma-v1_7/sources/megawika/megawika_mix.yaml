streams:
  - name: megawika
    documents:
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/af/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/az/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/cs/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/de/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/en/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/et/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/fa/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/fr/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/gu/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/hi/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/hr/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/id/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/it/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ja/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ka/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/kk/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/km/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ko/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/lv/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ml/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/mn/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/mr/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/my/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ne/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/pl/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ps/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/pt/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ro/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ru/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/sv/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ta/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/th/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/ur/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/vi/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/xh/*
      - s3://ai2-llm/pretraining-data/sources/megawika/v0/documents/zh/*
    attributes: &attributes
      - dedupe_para_ngrams_13_1
      - dedupe_para_ngrams_13_1_v2
      - gopher_v1
      - c4_v2
      - whitespace_tokenizer_v1
      - paloma_paragraphs
      - paloma_documents
      - pii_regex_with_counts_fast_v2
      - ft_lang_id_en_doc_v2
      - cc_multi_bin
      - dedupe_by_url
    output: &output
      max_size_in_bytes: 500_000_000
      path: s3://ai2-llm/pretraining-data/sources/megawika/v1/documents
      min_text_length: 25   # matches wikipedia
      discard_fields:
        - attributes
    filter: &filter
      include:
        # not a repeated doc
        # - >-
        #   (.attributes.dedupe_para_ngrams_13_1 | length == 0) or
        #   ((.attributes.dedupe_para_ngrams_13_1 | map(.[2] * (.[1] - .[0])) | add) / (.text | length) <= 0.3)
        - >-
          (.attributes.dedupe_para_ngrams_13_1_v2 | length == 0) or
          ((.attributes.dedupe_para_ngrams_13_1_v2 | map(.[2] * (.[1] - .[0])) | add) / (.text | length) <= 0.3)
      exclude:
      # Dedupe by URL
      - ".attributes.dedupe_by_url != null"

      # Language Id
      - .attributes.ft_lang_id_en_doc_v2__ft_lang_id_en_doc_v2__en[0][-1] < 0.5

      # C4 Rules
      - >-
        (.attributes.c4_v2__c4_v2__has_curly_brace != null) and
        (.attributes.c4_v2__c4_v2__has_curly_brace[0][2] > 0.5)
      - >-
        (.attributes.c4_v2__c4_v2__has_lorem_ipsum != null) and
        (.attributes.c4_v2__c4_v2__has_lorem_ipsum[0][2] > 0.5)
      - >-
        (.attributes.c4_v2__c4_v2__has_javascript != null) and
        (.attributes.c4_v2__c4_v2__has_javascript[0][2] > 0.5)

      # Gopher Rules
      - >-
        (.attributes.gopher_v1__gopher_v1__word_count != null) and
        (.attributes.gopher_v1__gopher_v1__word_count[0][2] < 50)
      - >-
        (.attributes.gopher_v1__gopher_v1__word_count != null) and
        (.attributes.gopher_v1__gopher_v1__word_count[0][2] > 100000)
      - >-
        (.attributes.gopher_v1__gopher_v1__median_word_length != null) and
        (.attributes.gopher_v1__gopher_v1__median_word_length[0][2] < 3)
      - >-
        (.attributes.gopher_v1__gopher_v1__median_word_length != null) and
        (.attributes.gopher_v1__gopher_v1__median_word_length[0][2] > 10)
      - >-
        (.attributes.gopher_v1__gopher_v1__symbol_to_word_ratio != null) and
        (.attributes.gopher_v1__gopher_v1__symbol_to_word_ratio[0][2] > 0.1)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_words_with_alpha_character != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_words_with_alpha_character[0][2] < 0.8)
      - >-
        (.attributes.gopher_v1__gopher_v1__required_word_count != null) and
        (.attributes.gopher_v1__gopher_v1__required_word_count[0][2] < 2)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_lines_starting_with_bullet_point != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_lines_starting_with_bullet_point[0][2] > 0.9)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_lines_ending_with_ellipsis != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_lines_ending_with_ellipsis[0][2] > 0.3)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_duplicate_lines != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_duplicate_lines[0][2] > 0.3)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_lines != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_lines[0][2] > 0.3)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_most_common_2gram != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_most_common_2gram[0][2] > 0.2)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_most_common_3gram != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_most_common_3gram[0][2] > 0.18)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_most_common_4gram != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_most_common_4gram[0][2] > 0.16)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_5grams != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_5grams[0][2] > 0.15)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_6grams != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_6grams[0][2] > 0.14)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_7grams != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_7grams[0][2] > 0.13)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_8grams != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_8grams[0][2] > 0.12)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_9grams != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_9grams[0][2] > 0.11)
      - >-
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_10grams != null) and
        (.attributes.gopher_v1__gopher_v1__fraction_of_characters_in_duplicate_10grams[0][2] > 0.10)

      # Contaminated Data from Paloma
      - ".attributes.paloma_documents_bff_duplicates != null"
      - "(.attributes.paloma_paragraphs_bff_duplicates | length) > 0"

      # Documents with too much PII
      - .attributes.pii_regex_with_counts_fast_v2__pii_regex_with_counts_fast_v2__doc_count[0][2] > 5

      # Remove repetitions
      - >-
        (.attributes.tokenizer_repetitions_v2r2__tokenizer_repetitions_v2r2__doc_max_score_repetition != null) and
        (.attributes.tokenizer_repetitions_v2r2__tokenizer_repetitions_v2r2__doc_max_score_repetition[0][-1] > 10)

      # Quality filter
      - .attributes.cc_multi_bin__cc_multi_bin__hq[0][-1] <= 0.1

      # Too few tokens
      - .attributes.whitespace_tokenizer_v1__whitespace_tokenizer_v1__length[0][-1] < 25
      syntax: jq

    span_replacement:
      - span: "$.attributes.dedupe_para_ngrams_13_1"
        min_score: 0.8
        replacement: ''


work_dir:
  input: "/tmp/megawika/input"
  output: "/tmp/megawika/output"

processes: 188
